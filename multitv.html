<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Multi TV | İnteraktif Izgara</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root { --accent:#ffcc00; --bg:#0f0f1a; --card:#1a1a2e; --input-bg:#22263a; --input-border:#3a3b53;}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#fff;background:var(--bg);margin:0;}
    body.has-fullscreen { overflow: hidden; }
    .header-bg{background:#0a0a14;padding:1rem;position:sticky;top:0;z-index:50;box-shadow:0 2px 8px rgba(0,0,0,.5)}
    .title{color:var(--accent);font-weight:700;text-align:center}
    .controls{display:flex;gap:.5rem;justify-content:center;margin-top:.5rem}

    #videoContainer{display:grid;gap:1rem;padding:1rem;transition:all .28s ease; grid-template-columns: repeat(var(--grid-columns, 3), 1fr);}

    .video-card{
      background:var(--card);border-radius:12px;overflow:hidden;position:relative;
      transition: transform .28s ease, box-shadow .28s ease, opacity .28s ease;
      display:flex;flex-direction:column; cursor:grab; touch-action: none;
    }
    .video-card:active { cursor: grabbing; }
    .video-card.dragging { opacity: 0.5; }
    .video-card.drag-over { border: 2px dashed var(--accent); }
    
    .video-card.fullscreen {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 100; border-radius: 0;
    }

    .video-card .frame{width:100%; aspect-ratio: 16 / 9; background:#000;position:relative; display: flex;}
    .video-card.fullscreen .frame { aspect-ratio: auto; flex-grow: 1; }
    .video-card iframe, .video-card video{width:100%;height:100%;border:0;display:block}

    .click-overlay {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        z-index: 5;
    }

    .video-card .card-footer{
        padding:.5rem 1rem;
        font-size:.875rem;color:var(--accent);background:rgba(0,0,0,.25)
    }
    
    .logo-overlay {
        position: absolute; top: 12px; left: 12px; z-index: 10; pointer-events: none;
    }
    .channel-logo{
        width:40px;height:40px;border-radius:50%;object-fit:cover;background:#333;
        border: 2px solid rgba(255, 255, 255, 0.5); box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .settings-logo-preview{width:32px;height:32px;border-radius:50%;object-fit:cover;background:#333;}
    
    .card-controls {
        position: absolute; top: 12px; right: 12px; z-index: 10;
        display: flex; gap: 0.5rem;
        opacity: 0; transition: opacity 0.2s;
    }
    .video-card:hover .card-controls { opacity: 1; }
    .control-btn {
        width: 32px; height: 32px; border-radius: 50%;
        background-color: rgba(0,0,0,0.6);
        border: none; color: white;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
    }

    #settingsOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:110;display:none;align-items:flex-start;justify-content:center;padding-top:40px;overflow:auto}
    #settingsOverlay.flex{display:flex}
    #settingsModal{width:95%;max-width:800px;background:var(--bg);border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.6);overflow:hidden}

    .panel-header{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:rgba(15,15,15,1);border-bottom:2px solid var(--accent)}
    .panel-body{padding:1.5rem}

    .channel-row{display:grid;grid-template-columns:auto auto 1fr 1fr 1.5fr auto;gap:.75rem;align-items:center;margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid var(--input-border)}
    .channel-row:last-child { border-bottom: none; }
    .channel-row input, .channel-row select {background:var(--input-bg);border-radius:8px;padding:.5rem;color:#fff;border:1px solid var(--input-border)}
    
    .simple-channel-row { display: flex; align-items: center; gap: 1rem; padding: 0.5rem; border-radius: 8px; transition: background-color 0.2s;}
    .simple-channel-row:hover { background-color: var(--input-bg); }
    .sortable-item.drag-over-settings { background-color: var(--input-border); }
    .drag-handle { cursor: move; color: #6c757d; }

    .category-title { color: var(--accent); font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }

    .small-btn{padding:.45rem .6rem;border-radius:8px;background:#303050;color:#fff;border:0;cursor:pointer; transition: background-color .2s;}
    .small-btn.active { background-color: var(--accent); color: var(--bg); font-weight: bold; }
    .small-btn:hover:not(:disabled) { background-color: #4a4a70; }
    .danger{background:#c03a3a}
    .danger:hover{background:#a03030}
    .muted{background:#22263a}
  </style>
</head>
<body>

  <div class="header-bg">
    <h1 class="title text-2xl">Çoklu Canlı Yayın Merkezi</h1>
    <div class="controls">
      <button class="small-btn" onclick="toggleSettingsOverlay(true)"><i class="fas fa-cog mr-2"></i>Ayarlar</button>
    </div>
  </div>

  <div id="videoContainer" aria-live="polite"></div>

  <div id="settingsOverlay" class="hidden" role="dialog" aria-modal="true">
    <div id="settingsModal">
      <div class="panel-header">
        <div style="display:flex;align-items:center;gap:.6rem">
          <i class="fas fa-tv" style="color:var(--accent)"></i>
          <strong style="color:var(--accent)">Multi TV | Ayarlar</strong>
        </div>
        <button class="small-btn muted" onclick="toggleSettingsOverlay(false)"><i class="fas fa-times"></i> Kapat</button>
      </div>
      <div id="settingsPanelBody" class="panel-body">
         <!-- Ayarlar içeriği buraya dinamik olarak yüklenecek -->
      </div>
    </div>
  </div>
  
  <div id="passwordOverlay" class="hidden fixed top-0 left-0 w-full h-full bg-black/70 z-[120] items-center justify-center p-4">
    <div id="passwordModal" class="w-full max-w-sm bg-[var(--bg)] border border-[var(--input-border)] rounded-lg shadow-xl p-6">
        <h3 class="text-xl font-bold text-center text-[var(--accent)] mb-4">Gelişmiş Ayarlar</h3>
        <p class="text-center text-gray-400 mb-6">Devam etmek için lütfen parolayı girin.</p>
        <input id="passwordInput" type="password" class="w-full text-center bg-[var(--input-bg)] border border-[var(--input-border)] rounded-lg p-3 text-lg" placeholder="••••">
        <p id="passwordError" class="text-red-500 text-center h-6 mt-2"></p>
        <div class="flex gap-4 mt-4">
            <button class="small-btn muted flex-1" onclick="closePasswordPrompt()">İptal</button>
            <button id="passwordSubmitBtn" class="small-btn flex-1" style="background-color:var(--accent); color:var(--bg); font-weight:bold;">Giriş</button>
        </div>
    </div>
  </div>

  <div id="update-banner" class="hidden fixed bottom-4 right-4 bg-[var(--accent)] text-[var(--bg)] p-4 rounded-lg shadow-lg items-center gap-4 z-[200]">
    <i id="update-icon" class="fas fa-arrow-circle-down"></i>
    <span id="update-text" class="font-bold">Yeni bir sürüm mevcut!</span>
    <button id="update-button" class="small-btn" style="background-color:var(--bg); color:white;" onclick="performUpdate()">Şimdi Güncelle</button>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    const SCRIPT_VERSION = '1.5'; // Mevcut script versiyonu

    const videoContainer = document.getElementById('videoContainer');
    const settingsOverlay = document.getElementById('settingsOverlay');
    const settingsPanelBody = document.getElementById('settingsPanelBody');
    const passwordOverlay = document.getElementById('passwordOverlay');
    const passwordInput = document.getElementById('passwordInput');
    const passwordSubmitBtn = document.getElementById('passwordSubmitBtn');
    const passwordError = document.getElementById('passwordError');

    let gridColumns = 3;
    let channels = [];
    let draggedItem = null;
    let sortableDraggedItem = null;
    let activeFullscreen = null;
    let activeResized = null;
    let isAdvancedView = false;
    let playerInstances = {};
    
    const categories = ["Genel", "Ulusal", "Haber", "Spor", "Kültür", "Çocuk", "Yerel", "Diğer"];

    const defaultChannels = [
      { name: 'NTV', id: 'c2e0p3dY3sI', logoUrl: 'https://yt3.googleusercontent.com/ytc/AIdro_k2zJNlpS2_Qp_v7Dp5O4i8m8e4a9ptT0D6jA=s176-c-k-c0x00ffffff-no-rj', visible: true, type: 'youtube', category: 'Haber' },
      { name: 'CNN Türk', id: 'rNZWLaC-oK4', logoUrl: 'https://yt3.googleusercontent.com/Uo0y5j5n0DJLdTlce3vqwuLSv08y2nQ2iS-DP0fI5pQ-iLCTx-u5C5rIOYw52v-s7zJBEuVr=s176-c-k-c0x00ffffff-no-rj', visible: true, type: 'youtube', category: 'Haber' },
      { name: 'Sözcü TV', id: 'tNb_rZwUcLo', logoUrl: 'https://yt3.googleusercontent.com/pL2c8GqWJpLHel-2C6VvAFf11Id1S-AJsQPblzYLIdaB0-27-0-j1s-0-PAGAD-wU64b4-d5=s176-c-k-c0x00ffffff-no-rj', visible: true, type: 'youtube', category: 'Haber' },
      { name: 'Habertürk', id: 'RNVNUSlJF-g', logoUrl: 'https://yt3.googleusercontent.com/ytc/AIdro_n11U2gY-2yv-Dwm-Awe5U5l3gE103e5i5W6g=s176-c-k-c0x00ffffff-no-rj', visible: true, type: 'youtube', category: 'Haber' },
      { name: 'TRT Spor', id: 'mNln_w_1B5s', logoUrl: 'https://yt3.googleusercontent.com/ytc/AIdro_l-T3w2Q4_3e6wO88E-p5b5523g8N2u8O7iA=s176-c-k-c0x00ffffff-no-rj', visible: true, type: 'youtube', category: 'Spor' },
      { name: 'Halk TV', id: 'V8U0QxGb8ew', logoUrl: 'https://yt3.googleusercontent.com/ytc/AIdro_kI794-6ZgY4EAMa2KZmy0W-zW-J-pCM6QUBA=s176-c-k-c0x00ffffff-no-rj', visible: false, type: 'youtube', category: 'Haber' },
    ];

    function performUpdate() {
        window.location.reload(true);
    }

    async function checkForUpdates(manualCheck = false) {
        const banner = document.getElementById('update-banner');
        const updateIcon = document.getElementById('update-icon');
        const updateText = document.getElementById('update-text');
        const updateButton = document.getElementById('update-button');

        try {
            const response = await fetch('version.json?t=' + new Date().getTime());
            if (!response.ok) {
                if (manualCheck) alert('Güncelleme sunucusuna ulaşılamadı.');
                return;
            }
            const data = await response.json();
            const latestVersion = data.version;
            const updateNotes = data.notes;

            if (latestVersion && latestVersion > SCRIPT_VERSION) {
                updateIcon.className = 'fas fa-arrow-circle-down';
                updateText.textContent = updateNotes || `Yeni sürüm (v${latestVersion}) mevcut!`;
                updateButton.style.display = 'block';
                banner.classList.remove('hidden');
                banner.classList.add('flex');
            } else if (manualCheck) {
                updateIcon.className = 'fas fa-check-circle';
                updateText.textContent = `Uygulama güncel (v${SCRIPT_VERSION})`;
                updateButton.style.display = 'none';
                banner.classList.remove('hidden');
                banner.classList.add('flex');
                setTimeout(() => {
                    banner.classList.add('hidden');
                    banner.classList.remove('flex');
                }, 3000);
            }
        } catch (error) {
            console.log("Güncelleme kontrolü başarısız...", error);
            if (manualCheck) {
                updateIcon.className = 'fas fa-times-circle';
                updateText.textContent = 'Kontrol başarısız!';
                updateButton.style.display = 'none';
                banner.classList.remove('hidden');
                banner.classList.add('flex');
                setTimeout(() => {
                    banner.classList.add('hidden');
                    banner.classList.remove('flex');
                }, 3000);
            }
        }
    }

    function extractVideoId(input) {
      if (!input) return null;
      const s = input.trim();
      const patterns = [ /(?:[?&]v=|\/embed\/|youtu\.be\/)([a-zA-Z0-9_-]{11})/, ];
      for (const pattern of patterns) {
        const match = s.match(pattern);
        if (match && match[1]) return match[1];
      }
      if (s.length === 11 && !s.includes('/')) return s;
      return s;
    }

    function toggleSettingsOverlay(show) {
      settingsOverlay.classList.toggle('hidden', !show);
      settingsOverlay.classList.toggle('flex', show);
      if (show) {
        isAdvancedView = false;
        renderSettingsPanel();
      }
    }

    function renderSettingsPanel() {
        const gridLayoutHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem;">
                <h3 style="margin:0;color:#ddd">Izgara Düzeni</h3>
                <div id="layout-controls" class="controls">
                    <button class="small-btn ${gridColumns === 2 ? 'active' : ''}" data-cols="2" onclick="setLayout(2)">2</button>
                    <button class="small-btn ${gridColumns === 3 ? 'active' : ''}" data-cols="3" onclick="setLayout(3)">3</button>
                    <button class="small-btn ${gridColumns === 4 ? 'active' : ''}" data-cols="4" onclick="setLayout(4)">4</button>
                </div>
            </div>
            <hr style="margin:1.5rem 0;border-color:#222"/>
        `;
        
        settingsPanelBody.innerHTML = gridLayoutHTML + (isAdvancedView ? renderAdvancedSettings() : renderSimpleSettings());
        if (!isAdvancedView) {
            addSettingsDragDropListeners();
        }
    }
    
    function renderSimpleSettings() {
        const groupedChannels = channels.reduce((acc, channel) => {
            const category = channel.category || 'Kategorisiz';
            if (!acc[category]) acc[category] = [];
            acc[category].push(channel);
            return acc;
        }, {});

        let visibilityHTML = '';
        for (const category of categories) {
            if (groupedChannels[category]) {
                visibilityHTML += `<h4 class="category-title">${category}</h4>`;
                groupedChannels[category].forEach(c => {
                    const i = channels.indexOf(c);
                    visibilityHTML += `
                        <div class="simple-channel-row">
                            <img src="${c.logoUrl || 'https://placehold.co/32x32/333/fff?text=?'}" class="settings-logo-preview" onerror="this.src='https://placehold.co/32x32/333/fff?text=?'">
                            <span class="flex-1">${c.name}</span>
                            <button class="small-btn" onclick="toggleVisibilitySimple(${i})" title="Görünürlüğü değiştir">
                                <i class="fas ${c.visible ? 'fa-eye' : 'fa-eye-slash'}"></i>
                            </button>
                        </div>
                    `;
                });
            }
        }
        
        let sortableListHTML = '';
        channels.forEach((c, i) => {
            sortableListHTML += `
                <div class="simple-channel-row sortable-item" draggable="true" data-index="${i}">
                    <i class="fas fa-bars drag-handle"></i>
                    <img src="${c.logoUrl || 'https://placehold.co/32x32/333/fff?text=?'}" class="settings-logo-preview" onerror="this.src='https://placehold.co/32x32/333/fff?text=?'">
                    <span class="flex-1">${c.name}</span>
                </div>
            `;
        });

        return `
            <h3 style="margin:0 0 1rem 0;color:#ddd">Görünür Kanallar</h3>
            <div class="space-y-2">${visibilityHTML}</div>
            <hr style="margin:1.5rem 0;border-color:#222"/>
            <h3 style="margin:0 0 1rem 0;color:#ddd">Kanal Sıralaması</h3>
            <div id="sortableChannelList" class="space-y-2">${sortableListHTML}</div>
            <hr style="margin:1.5rem 0;border-color:#222"/>
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500">Sürüm ${SCRIPT_VERSION}</span>
                    <button class="small-btn" onclick="checkForUpdates(true)" title="Güncellemeleri kontrol et"><i class="fas fa-sync-alt"></i></button>
                </div>
                <button class="small-btn" onclick="promptForAdvancedSettings()"><i class="fas fa-cogs mr-2"></i>+ Daha Fazla Ayar</button>
            </div>
        `;
    }

    function renderAdvancedSettings() {
        let channelListHTML = '';
        channels.forEach((c, i) => {
            const sourceInputHTML = c.type === 'youtube'
                ? `<div class="flex items-center rounded-lg bg-[var(--input-bg)] border border-[var(--input-border)]">
                     <span class="text-gray-400 text-sm px-3">youtube.com/watch?v=</span>
                     <input type="text" class="flex-1 bg-transparent border-0 !ring-0 !outline-none p-2" value="${c.id || ''}" placeholder="Yayın ID" oninput="channels[${i}].id = this.value">
                   </div>`
                : `<input type="text" value="${c.id || ''}" placeholder="Tam .m3u8 linki" oninput="channels[${i}].id = this.value">`;
            
            const categoryOptions = categories.map(cat => `<option value="${cat}" ${c.category === cat ? 'selected' : ''}>${cat}</option>`).join('');

            channelListHTML += `
              <div class="channel-row">
                <div class="flex flex-col gap-2">
                  <button class="small-btn" onclick="toggleVisibility(${i})" title="Görünürlüğü değiştir">
                    <i class="fas ${c.visible ? 'fa-eye' : 'fa-eye-slash'}"></i>
                  </button>
                   <button class="small-btn danger" onclick="removeChannel(${i})" title="Kanalı sil"><i class="fas fa-trash"></i></button>
                </div>
                <img src="${c.logoUrl || 'https://placehold.co/32x32/333/fff?text=?'}" class="settings-logo-preview" onerror="this.src='https://placehold.co/32x32/333/fff?text=?'">
                <div class="flex flex-col gap-2">
                  <input type="text" value="${c.name || ''}" placeholder="Kanal adı" oninput="channels[${i}].name = this.value">
                  <input type="text" value="${c.logoUrl || ''}" placeholder="Logo URL" oninput="updateLogoUrl(this, ${i})">
                </div>
                <div class="flex flex-col gap-2">
                   <select onchange="channels[${i}].category = this.value">${categoryOptions}</select>
                   <div class="flex gap-2">
                      <button class="small-btn flex-1 ${c.type === 'youtube' ? 'active' : ''}" onclick="setChannelType(${i}, 'youtube')">YouTube</button>
                      <button class="small-btn flex-1 ${c.type === 'm3u8' ? 'active' : ''}" onclick="setChannelType(${i}, 'm3u8')">M3U8</button>
                  </div>
                </div>
                <div class="flex flex-col gap-2 justify-center">${sourceInputHTML}</div>
              </div>
            `;
        });

        return `
            <h3 style="margin:0 0 1rem 0;color:#ddd">Kanal Listesi (Gelişmiş)</h3>
            <div id="advancedChannelList">${channelListHTML}</div>
            <div class="flex justify-between items-center mt-4">
              <div>
                  <button class="small-btn" onclick="addChannel()"><i class="fas fa-plus mr-1"></i> Yeni kanal</button>
                  <button class="small-btn" onclick="resetToDefaults()">Varsayılanları Yükle</button>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500">Sürüm ${SCRIPT_VERSION}</span>
                <button class="small-btn" onclick="checkForUpdates(true)" title="Güncellemeleri kontrol et"><i class="fas fa-sync-alt"></i></button>
              </div>
              <button class="small-btn" style="background-color:var(--accent); color:var(--bg); font-weight:bold;" onclick="saveAndReload()"><i class="fas fa-save mr-1"></i> Kaydet ve Kapat</button>
            </div>
        `;
    }

    function promptForAdvancedSettings() {
        passwordOverlay.classList.remove('hidden');
        passwordOverlay.classList.add('flex');
        passwordInput.focus();
    }
    
    function closePasswordPrompt() {
        passwordOverlay.classList.add('hidden');
        passwordOverlay.classList.remove('flex');
        passwordInput.value = '';
        passwordError.textContent = '';
    }

    function checkPassword() {
        if (passwordInput.value === "1995") {
            isAdvancedView = true;
            renderSettingsPanel();
            closePasswordPrompt();
        } else {
            passwordError.textContent = "Parola yanlış!";
            passwordInput.value = '';
            passwordInput.focus();
        }
    }
    
    function addSettingsDragDropListeners() {
        const items = document.querySelectorAll('#sortableChannelList .sortable-item');
        items.forEach(item => {
            item.addEventListener('dragstart', handleSortableDragStart);
            item.addEventListener('dragover', handleSortableDragOver);
            item.addEventListener('dragleave', handleSortableDragLeave);
            item.addEventListener('drop', handleSortableDrop);
            item.addEventListener('dragend', handleSortableDragEnd);
        });
    }

    function handleSortableDragStart(e) {
        sortableDraggedItem = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.dataset.index);
        setTimeout(() => { this.style.opacity = '0.5'; }, 0);
    }

    function handleSortableDragEnd() {
        if(sortableDraggedItem) {
            sortableDraggedItem.style.opacity = '1';
        }
        document.querySelectorAll('.drag-over-settings').forEach(el => el.classList.remove('drag-over-settings'));
        sortableDraggedItem = null;
    }

    function handleSortableDragOver(e) {
        e.preventDefault();
        this.classList.add('drag-over-settings');
    }

    function handleSortableDragLeave() {
        this.classList.remove('drag-over-settings');
    }

    function handleSortableDrop(e) {
        e.stopPropagation();
        if (sortableDraggedItem !== this) {
            const draggedIndex = parseInt(sortableDraggedItem.dataset.index);
            const targetIndex = parseInt(this.dataset.index);

            if (!isNaN(draggedIndex) && !isNaN(targetIndex)) {
                const [removed] = channels.splice(draggedIndex, 1);
                channels.splice(targetIndex, 0, removed);
                
                saveSettings();
                loadStreams();
                renderSettingsPanel();
            }
        }
        return false;
    }

    function setChannelType(index, type) {
        if (channels[index].type !== type) {
            channels[index].type = type;
            channels[index].id = '';
            renderSettingsPanel();
        }
    }

    function updateLogoUrl(inputElement, index) {
        channels[index].logoUrl = inputElement.value;
        const img = inputElement.closest('.channel-row').querySelector('.settings-logo-preview');
        if (img) { img.src = inputElement.value || 'https://placehold.co/32x32/333/fff?text=?'; }
    }

    function addChannel() {
      channels.push({ name: 'Yeni Kanal', id: '', logoUrl: '', visible: true, type: 'youtube', category: 'Diğer' });
      renderSettingsPanel();
    }

    function removeChannel(i) {
      if (confirm(`'${channels[i].name}' kanalını silmek istediğinizden emin misiniz?`)) {
        channels.splice(i, 1);
        renderSettingsPanel();
      }
    }
    
    function toggleVisibility(i) {
        channels[i].visible = !channels[i].visible;
        renderSettingsPanel();
    }
    
    function toggleVisibilitySimple(i) {
        channels[i].visible = !channels[i].visible;
        saveSettings();
        loadStreams();
        renderSettingsPanel();
    }

    function resetToDefaults() {
      if (confirm('Tüm kanalları varsayılan listeyle değiştirmek istediğinizden emin misiniz?')) {
        channels = JSON.parse(JSON.stringify(defaultChannels));
        renderSettingsPanel();
      }
    }

    function saveSettings() {
        const settings = { channels: channels, gridColumns: gridColumns };
        localStorage.setItem('multiTvSettings', JSON.stringify(settings));
    }

    function loadSettings() {
        const saved = localStorage.getItem('multiTvSettings');
        if (saved) {
            const settings = JSON.parse(saved);
            channels = (settings.channels || JSON.parse(JSON.stringify(defaultChannels))).map(c => ({
                ...c,
                type: c.type || (c.id && c.id.toLowerCase().includes('.m3u8') ? 'm3u8' : 'youtube'),
                category: c.category || 'Diğer'
            }));
            gridColumns = settings.gridColumns || 3;
        } else {
            channels = JSON.parse(JSON.stringify(defaultChannels));
            gridColumns = 3;
        }
    }

    function saveAndReload() {
      saveSettings();
      loadStreams();
      toggleSettingsOverlay(false);
    }

    function setLayout(cols) {
      gridColumns = cols;
      document.documentElement.style.setProperty('--grid-columns', gridColumns);
      renderSettingsPanel();
    }
    
    function destroyPlayers() {
        for (const key in playerInstances) {
            if (playerInstances[key] && playerInstances[key].yt && typeof playerInstances[key].yt.destroy === 'function') {
                playerInstances[key].yt.destroy();
            }
             if (playerInstances[key] && playerInstances[key].hls && typeof playerInstances[key].hls.destroy === 'function') {
                playerInstances[key].hls.destroy();
            }
        }
        playerInstances = {};
    }

    function loadStreams() {
      destroyPlayers();
      videoContainer.innerHTML = '';
      const visibleChannels = channels.filter(c => c.visible);

      if (!visibleChannels.length) {
        videoContainer.innerHTML = '<p class="text-center text-yellow-500 col-span-full">Gösterilecek aktif kanal yok.</p>';
        return;
      }

      visibleChannels.forEach((ch, idx) => {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.dataset.id = ch.id; 
        card.draggable = true;
        const frameWrap = document.createElement('div');
        frameWrap.className = 'frame';
        const playerContainerId = `player-${idx}`;

        if (ch.type === 'm3u8' && ch.id) {
          const video = document.createElement('video');
          video.id = playerContainerId;
          video.autoplay = true; video.muted = true; video.playsInline = true;
          frameWrap.appendChild(video);
          if (Hls.isSupported()) { 
              const hls = new Hls(); hls.loadSource(ch.id); hls.attachMedia(video);
              playerInstances[playerContainerId] = { video, hls };
           }
          else if (video.canPlayType('application/vnd.apple.mpegurl')) { 
              video.src = ch.id;
              playerInstances[playerContainerId] = { video };
          }
        } else if (ch.type === 'youtube' && ch.id) {
          const playerDiv = document.createElement('div');
          playerDiv.id = playerContainerId;
          frameWrap.appendChild(playerDiv);
          // Player will be created by onYouTubeIframeAPIReady
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'flex items-center justify-center w-full h-full bg-black text-gray-400';
          placeholder.innerHTML = '<i class="fas fa-video-slash text-2xl"></i>';
          frameWrap.appendChild(placeholder);
        }
        
        const logoOverlay = document.createElement('div');
        logoOverlay.className = 'logo-overlay';
        logoOverlay.innerHTML = `<img src="${ch.logoUrl || 'https://placehold.co/40x40/333/fff?text=?'}" class="channel-logo" onerror="this.src='https://placehold.co/40x40/333/fff?text=?'">`;
        
        const clickOverlay = document.createElement('div');
        clickOverlay.className = 'click-overlay';
        
        const controls = document.createElement('div');
        controls.className = 'card-controls';
        controls.innerHTML = `
            <button class="control-btn mute-btn" title="Sesi aç/kapat" onclick="toggleMute(event, '${playerContainerId}')"><i class="fas fa-volume-mute"></i></button>
            <button class="control-btn" title="Tam Ekran" onclick="toggleFullscreen(event)"><i class="fas fa-expand"></i></button>
        `;

        const footer = document.createElement('div');
        footer.className = 'card-footer';
        footer.textContent = ch.name || 'İsimsiz Kanal';
        
        frameWrap.appendChild(logoOverlay);
        frameWrap.appendChild(clickOverlay);
        frameWrap.appendChild(controls);
        card.append(frameWrap, footer);
        videoContainer.appendChild(card);
      });
      createAllYouTubePlayers();
      addCardListeners();
    }
    
    function createAllYouTubePlayers() {
        channels.filter(c => c.visible && c.type === 'youtube' && c.id).forEach((ch, idx) => {
            const playerContainerId = `player-${channels.filter(c => c.visible).indexOf(ch)}`;
            createYouTubePlayer(playerContainerId, ch);
        });
    }

    function createYouTubePlayer(elementId, channel) {
        const vid = extractVideoId(channel.id);
        const player = new YT.Player(elementId, {
            height: '100%', width: '100%', videoId: vid,
            playerVars: { autoplay: 1, mute: 1, controls: 0, rel: 0, playsinline: 1, loop: 1, playlist: vid },
            events: { 'onReady': (event) => { playerInstances[elementId] = { yt: event.target }; } }
        });
    }

    function toggleMute(event, playerId) {
        event.stopPropagation();
        const playerInfo = playerInstances[playerId];
        const icon = event.currentTarget.querySelector('i');
        if (!playerInfo) return;

        if (playerInfo.yt) { // YouTube
            if (playerInfo.yt.isMuted()) {
                playerInfo.yt.unMute();
                icon.className = 'fas fa-volume-up';
            } else {
                playerInfo.yt.mute();
                icon.className = 'fas fa-volume-mute';
            }
        } else if (playerInfo.video) { // HLS
            playerInfo.video.muted = !playerInfo.video.muted;
            icon.className = playerInfo.video.muted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
        }
    }
    
    function addCardListeners() {
        document.querySelectorAll('.video-card').forEach(card => {
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragenter', handleDragEnter);
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('dragleave', handleDragLeave);
            card.addEventListener('drop', handleDrop);
            card.addEventListener('dragend', handleDragEnd);
            card.querySelector('.click-overlay').addEventListener('dblclick', (e) => toggleFullscreen(e));
            
            interact(card).resizable({
                edges: { left: true, right: true, bottom: true, top: true },
                listeners: {
                    start(event) {
                        activeResized = event.target;
                        event.target.style.zIndex = 50;
                    },
                    move(event) {
                        let { x, y } = event.target.dataset;
                        x = (parseFloat(x) || 0) + event.deltaRect.left;
                        y = (parseFloat(y) || 0) + event.deltaRect.top;
                        Object.assign(event.target.style, {
                            width: `${event.rect.width}px`,
                            height: `${event.rect.height}px`,
                            transform: `translate(${x}px, ${y}px)`
                        });
                        Object.assign(event.target.dataset, { x, y });
                    }
                },
                modifiers: [ interact.modifiers.restrictSize({ min: { width: 150, height: 100 } }) ],
                inertia: true
            });
        });
    }

    function toggleFullscreen(event) {
        const card = event.currentTarget.closest('.video-card');
        if (!card) return;
        event.stopPropagation();
        
        if (activeFullscreen) {
            exitFullscreen();
        } else {
            card.classList.add('fullscreen');
            document.body.classList.add('has-fullscreen');
            activeFullscreen = card;
            card.querySelector('.click-overlay').addEventListener('click', exitFullscreen, { once: true });
        }
    }
    
    function exitFullscreen() {
        if (activeFullscreen) {
            activeFullscreen.classList.remove('fullscreen');
            document.body.classList.remove('has-fullscreen');
            activeFullscreen = null;
        }
    }
    
    function resetResized() {
        if(activeResized) {
            activeResized.style.width = '';
            activeResized.style.height = '';
            activeResized.style.transform = '';
            activeResized.style.zIndex = '';
            delete activeResized.dataset.x;
            delete activeResized.dataset.y;
            activeResized = null;
        }
    }

    function handleEscKey(e) {
        if (e.key === 'Escape') {
            if (activeFullscreen) { exitFullscreen(); } 
            else if (activeResized) { resetResized(); }
        }
    }
    
    document.addEventListener('keydown', handleEscKey);

    function handleDragStart(e) {
        draggedItem = e.currentTarget;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedItem.dataset.id);
        setTimeout(() => draggedItem.classList.add('dragging'), 0);
    }
    
    function handleDragEnd() {
        if(draggedItem) { draggedItem.classList.remove('dragging'); }
        document.querySelectorAll('.drag-over').forEach(c => c.classList.remove('drag-over'));
        draggedItem = null;
    }
    
    function handleDragOver(e) { e.preventDefault(); }
    function handleDragEnter(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
    function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }

    function handleDrop(e) {
        e.stopPropagation();
        const dropTarget = e.currentTarget;
        if (draggedItem !== dropTarget) {
            const draggedId = e.dataTransfer.getData('text/plain');
            const targetId = dropTarget.dataset.id;
            const draggedIndex = channels.findIndex(c => c.id === draggedId);
            const targetIndex = channels.findIndex(c => c.id === targetId);
            if (draggedIndex > -1 && targetIndex > -1) {
                const [removed] = channels.splice(draggedIndex, 1);
                channels.splice(targetIndex, 0, removed);
                saveSettings();
                loadStreams();
            }
        }
        return false;
    }
    
    function onYouTubeIframeAPIReady() {
        loadSettings();
        setLayout(gridColumns);
        loadStreams();
        checkForUpdates();
    }
    
    passwordSubmitBtn.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') checkPassword();
    });
    passwordOverlay.addEventListener('click', e => { if (e.target === passwordOverlay) closePasswordPrompt(); });

    settingsOverlay.addEventListener('click', e => { if (e.target === settingsOverlay) toggleSettingsOverlay(false); });
  </script>
</body>
</html>

